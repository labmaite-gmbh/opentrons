name: 'Create PR on macos-12 for Pipfile.lock'

on:
  push:
    paths:
    - '**setup.py'
    - '**Pipfile.*'
    branches:
      - '!edge'
      - '!release'
      - 'update-buildroot-2022.02.4' # remove before merge
  pull_request:
    paths:
    - '**/setup.py'
    - '**/Pipfile.*'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.ref_name != 'edge' || github.run_id}}-${{ github.ref_type != 'tag' || github.run_id }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  test:
    name: 'If there are Pipfile.lock changes make a PR'
    timeout-minutes: 35
    runs-on: 'macos-12'
    steps:
      - uses: 'actions/checkout@v3'
      - uses: 'actions/setup-node@v3'
        with:
          node-version: '14'
      - uses: 'actions/setup-python@v4'
        with:
          python-version: '3.10'
      - name: 'set complex environment variables'
        uses: actions/github-script@v6.1.1
        with:
          script: |
            const { buildComplexEnvVars, } = require(`${process.env.GITHUB_WORKSPACE}/.github/workflows/utils.js`)
            buildComplexEnvVars(core, context)
      - name: Install pipenv
        run: pip install pipenv==2021.5.29
      - name: Install shared-data
        working-directory: shared-data/python
        run: pipenv install -d
      - name: Install api
        working-directory: api
        run: pipenv install -d
      - name: Install notify-server
        working-directory: notify-server
        run: pipenv install -d
      - name: Install update-server
        working-directory: update-server
        run: pipenv install -d
      - name: Install robot-server
        working-directory: robot-server
        run: pipenv install -d
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Update Pipfile.lock on branch ${{ github.ref_name }}
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: false
          branch: pipfile-lock-${{ github.ref_name }}
          delete-branch: true
          title: Update Pipfile.lock on branch ${{ github.ref_name }}
          body: |
            Update all Pipfile.lock if needed
            - Pipfile.lock only updated on mac-12 GitHub runner
            - Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          draft: false
